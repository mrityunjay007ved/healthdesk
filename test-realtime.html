<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔄 Real-time Messaging Test - HealthDesk</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #333; 
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        button:hover { 
            background: #0056b3; 
        }
        .log { 
            background: #1e1e1e; 
            color: #00ff00; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 Real-time Messaging Test</h1>
        
        <div class="test-section">
            <h3>📋 Test Controls</h3>
            <button onclick="testEventListener()">🎧 Test Event Listener</button>
            <button onclick="testSendMessage()">📤 Send Test Message</button>
            <button onclick="testDataManager()">🔧 Test Data Manager</button>
            <button onclick="clearLog()">🧹 Clear Log</button>
        </div>
        
        <div class="test-section">
            <h3>📊 System Status</h3>
            <div id="status" class="status info">Ready to test...</div>
        </div>
        
        <div class="test-section">
            <h3>📋 Debug Log</h3>
            <div id="log" class="log">Starting real-time messaging test...\n</div>
        </div>
    </div>

    <script src="data-manager.js"></script>
    <script>
        let messageCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            
            // Update status
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared...\n';
        }
        
        // Test event listener
        function testEventListener() {
            log('🎧 Testing event listener setup...', 'info');
            
            // Remove any existing listener
            window.removeEventListener('elyxNewMessage', testMessageHandler);
            window.removeEventListener('storage', testCrossTabHandler);
            
            // Add test listeners
            window.addEventListener('elyxNewMessage', testMessageHandler);
            window.addEventListener('storage', testCrossTabHandler);
            log('✅ Test event listeners attached', 'success');
            
            // Simulate same-tab event
            setTimeout(() => {
                log('🚀 Dispatching same-tab test event...', 'info');
                const testEvent = new CustomEvent('elyxNewMessage', {
                    detail: {
                        type: 'test',
                        message: { id: 'test123', content: 'Test message' },
                        conversation: { id: 'test_conv', participantIds: [1, 2] },
                        timestamp: new Date().toISOString()
                    }
                });
                window.dispatchEvent(testEvent);
            }, 500);
            
            // Simulate cross-tab event
            setTimeout(() => {
                log('📡 Testing cross-tab communication...', 'info');
                const crossTabData = {
                    type: 'elyxNewMessage',
                    detail: {
                        type: 'test',
                        message: { id: 'test456', content: 'Cross-tab test message' },
                        conversation: { id: 'test_conv', participantIds: [1, 2] },
                        timestamp: new Date().toISOString()
                    },
                    timestamp: Date.now(),
                    tabId: 'test_tab'
                };
                localStorage.setItem(`elyx_broadcast_${Date.now()}_test`, JSON.stringify(crossTabData));
            }, 1000);
        }
        
        function testMessageHandler(event) {
            log(`🔔 TEST EVENT RECEIVED: ${JSON.stringify(event.detail)}`, 'success');
        }
        
        function testCrossTabHandler(event) {
            if (event.key && event.key.startsWith('elyx_broadcast_')) {
                log(`📡 CROSS-TAB EVENT RECEIVED: ${event.key}`, 'success');
                try {
                    const data = JSON.parse(event.newValue);
                    log(`📨 Cross-tab data: ${JSON.stringify(data)}`, 'success');
                } catch (e) {
                    log(`❌ Error parsing cross-tab data: ${e.message}`, 'error');
                }
            }
        }
        
        // Test data manager
        async function testDataManager() {
            try {
                log('🔧 Testing data manager...', 'info');
                
                if (!window.dataManager) {
                    log('❌ Data manager not found', 'error');
                    return;
                }
                
                await window.dataManager.loadData();
                log('✅ Data manager loaded', 'success');
                
                // Check users
                const users = window.dataManager.data.users;
                log(`👥 Found ${users.length} users`, 'success');
                
                // Check conversations
                const conversations = window.dataManager.data.conversations;
                log(`💬 Found ${conversations.length} conversations`, 'success');
                
                log('🔧 Data manager test complete', 'success');
                
            } catch (error) {
                log(`❌ Data manager test failed: ${error.message}`, 'error');
            }
        }
        
        // Test sending message
        async function testSendMessage() {
            try {
                log('📤 Testing message send...', 'info');
                
                if (!window.dataManager) {
                    log('❌ Data manager not available', 'error');
                    return;
                }
                
                await window.dataManager.loadData();
                
                // Get or create conversation between user 1 and 2
                const conversation = await window.dataManager.getOrCreateConversation(1, 2);
                log(`💬 Got conversation: ${conversation.id}`, 'success');
                
                // Send test message
                messageCount++;
                const message = await window.dataManager.sendMessage(
                    2, // Doctor ID
                    conversation.id,
                    `Test message #${messageCount} from test page`,
                    'text',
                    { context: 'test', priority: 'normal', testMessage: true }
                );
                
                log(`✅ Message sent: ${message.id}`, 'success');
                log(`📝 Message content: "${message.content}"`, 'info');
                
            } catch (error) {
                log(`❌ Message send failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        // Add member dashboard listener to test cross-page communication
        function testMemberListener(event) {
            log(`🏃‍♂️ MEMBER LISTENER RECEIVED: ${JSON.stringify(event.detail)}`, 'success');
        }
        
        // Add doctor dashboard listener to test cross-page communication  
        function testDoctorListener(event) {
            log(`👩‍⚕️ DOCTOR LISTENER RECEIVED: ${JSON.stringify(event.detail)}`, 'success');
        }
        
        // Initialize
        window.addEventListener('load', async function() {
            log('🚀 Page loaded, initializing test...', 'info');
            
            // Add both listeners
            window.addEventListener('elyxNewMessage', testMemberListener);
            window.addEventListener('elyxNewMessage', testDoctorListener);
            
            // Test data manager
            try {
                await window.dataManager.loadData();
                log('✅ Data manager auto-loaded', 'success');
            } catch (error) {
                log(`⚠️ Data manager auto-load failed: ${error.message}`, 'error');
            }
            
            log('🎯 Test page ready! Use buttons above to test.', 'success');
        });
    </script>
</body>
</html>
